global
    log stdout format raw local0 info
    maxconn 8192
    daemon

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    timeout tunnel  1h

frontend main
    bind *:80
    mode http
    
    # Streaming Service
    acl is_streaming_api path_beg /streaming/
    acl is_streaming_ws path_beg /ws/events/ /ws/dashboard
    
    # MediaMTX Direct
    acl is_hls path_beg /hls/
    acl is_webrtc_direct path_beg /webrtc/
    acl is_video_file path_end .m3u8 .mp4 .m4s .ts
    
    # Django/Admin
    acl is_admin path_beg /admin/
    acl is_api path_beg /api/
    
    # Estáticos
    acl is_static path_beg /static/ /media/
    
    # Frontend Vite
    acl is_vite_asset path_beg /@vite/ /@fs/ /src/ /node_modules/ /assets/
    acl is_vite_asset path_end .ts .tsx .js .jsx .css .json
    
    # Roteamento
    use_backend streaming_service if is_streaming_api
    use_backend streaming_service if is_streaming_ws
    use_backend mediamtx_hls if is_hls
    use_backend mediamtx_hls if is_video_file
    use_backend mediamtx_webrtc if is_webrtc_direct
    use_backend kong_gateway if is_admin
    use_backend kong_gateway if is_api
    use_backend nginx_static if is_static
    use_backend frontend_dev if is_vite_asset
    
    default_backend frontend_dev

backend streaming_service
    mode http
    http-request replace-path /streaming/(.*) /\1
    server streaming1 streaming:8001 check

backend mediamtx_hls
    mode http
    http-request replace-path /hls/(.*) /\1
    server mediamtx1 mediamtx:8888 check

backend mediamtx_webrtc
    mode http
    stick-table type ip size 100k expire 30m
    stick on src
    server mediamtx1 mediamtx:8889 check

backend kong_gateway
    mode http
    server kong1 kong:8000 check

backend nginx_static
    mode http
    server nginx1 nginx:80 check

backend frontend_dev
    mode http
    server frontend1 frontend:5173 check

listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s

# ATENÇÃO: É obrigatório haver uma linha vazia abaixo para evitar erro de parsing do HAProxy.