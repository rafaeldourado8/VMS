global
    log stdout format raw local0 info
    maxconn 4096                    # CONFIGURÁVEL: Aumentar para mais clientes simultâneos
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s              # CONFIGURÁVEL: Timeout de conexão
    timeout client  30s             # CONFIGURÁVEL: Timeout do cliente
    timeout server  30s             # CONFIGURÁVEL: Timeout do servidor
    timeout tunnel  1h              # CONFIGURÁVEL: Para WebSocket/WebRTC (longa duração)

# ============================================
# FRONTEND - ENTRADA ÚNICA (SPLIT-BRAIN)
# ============================================
frontend main
    bind *:80
    mode http
    
    # ACLs para detectar tipo de tráfego
    # CONFIGURÁVEL: Ajustar paths conforme necessário
    acl is_hls path_beg /hls/
    acl is_webrtc path_beg /ws/live/
    acl is_video_file path_end .m3u8 .mp4
    acl is_admin path_beg /admin/
    acl is_api path_beg /api/
    acl is_gateway path_beg /fast-api/ /docs /openapi.json
    acl is_static path_beg /static/ /media/
    acl is_vite_asset path_beg /@vite/ /@fs/ /src/ /node_modules/ /assets/
    acl is_vite_asset path_end .ts .tsx .js .jsx .css .json
    
    # Roteamento: Django Admin e API (PRIMEIRO - prioridade)
    use_backend django_backend if is_admin
    use_backend django_backend if is_api
    
    # Roteamento: Gateway FastAPI
    use_backend api_gateway if is_gateway
    
    # Roteamento: Estáticos
    use_backend nginx_static if is_static
    
    # Roteamento: VÍDEO
    use_backend mediamtx_hls if is_hls
    use_backend mediamtx_hls if is_video_file
    use_backend mediamtx_webrtc if is_webrtc
    
    # Roteamento: Frontend Vite Dev (HMR + Assets)
    use_backend frontend_dev if is_vite_asset
    
    # Default: Frontend
    default_backend frontend_dev

# ============================================
# BACKEND - MediaMTX HLS (Vídeo)
# ============================================
backend mediamtx_hls
    mode http
    balance roundrobin
    
    # Remove /hls/ do path antes de enviar para MediaMTX
    http-request replace-path /hls/(.*) /\1
    
    server mediamtx1 mediamtx:8888 check inter 10s fall 3 rise 2
    
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Cache-Control "no-cache"

# ============================================
# BACKEND - MediaMTX WebRTC (Vídeo Baixa Latência)
# ============================================
backend mediamtx_webrtc
    mode http
    balance roundrobin
    option httpchk GET /
    
    # Sticky session para WebRTC (importante!)
    stick-table type ip size 100k expire 30m
    stick on src
    
    # CONFIGURÁVEL: Adicionar mais instâncias MediaMTX
    server mediamtx1 mediamtx:8889 check inter 10s fall 3 rise 2
    
    # Headers para WebSocket
    http-response set-header Access-Control-Allow-Origin "*"

# ============================================
# BACKEND - Django (Admin + API)
# ============================================
backend django_backend
    mode http
    balance roundrobin
    
    server backend1 backend:8000 check inter 10s fall 3 rise 2
    
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Proto https if { ssl_fc }

# ============================================
# BACKEND - API Gateway (FastAPI)
# ============================================
backend api_gateway
    mode http
    balance roundrobin              # CONFIGURÁVEL: leastconn para melhor distribuição
    option httpchk GET /docs
    
    # CONFIGURÁVEL: Adicionar mais réplicas do Gateway
    server gateway1 gateway:8000 check inter 10s fall 3 rise 2
    # server gateway2 gateway:8000 check inter 10s fall 3 rise 2
    
    # Headers para API
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Proto https if { ssl_fc }

# ============================================
# BACKEND - Nginx (Estáticos)
# ============================================
backend nginx_static
    mode http
    balance roundrobin
    
    server nginx1 nginx:80 check inter 10s fall 3 rise 2
    
    http-response set-header Cache-Control "public, max-age=604800"

# ============================================
# BACKEND - Frontend Vite Dev
# ============================================
backend frontend_dev
    mode http
    balance roundrobin
    
    server frontend1 frontend:5173 check inter 10s fall 3 rise 2
    
    # WebSocket para HMR
    http-request set-header X-Forwarded-For %[src]
    http-response set-header Access-Control-Allow-Origin "*"

# ============================================
# STATS (Monitoramento HAProxy)
# ============================================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
