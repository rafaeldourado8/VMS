global
    log stdout format raw local0 info
    maxconn 4096                    # CONFIGURÁVEL: Aumentar para mais clientes simultâneos
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s              # CONFIGURÁVEL: Timeout de conexão
    timeout client  30s             # CONFIGURÁVEL: Timeout do cliente
    timeout server  30s             # CONFIGURÁVEL: Timeout do servidor
    timeout tunnel  1h              # CONFIGURÁVEL: Para WebSocket/WebRTC (longa duração)

# ============================================
# FRONTEND - ENTRADA ÚNICA (SPLIT-BRAIN)
# ============================================
frontend main
    bind *:80
    mode http
    
    # ACLs para detectar tipo de tráfego
    # CONFIGURÁVEL: Ajustar paths conforme necessário
    acl is_hls path_beg /hls/
    acl is_webrtc path_beg /ws/live/
    acl is_video_file path_end .m3u8 .ts .mp4
    acl is_api path_beg /api/ /admin/ /fast-api/ /docs /openapi.json
    acl is_static path_beg /static/ /media/
    
    # Roteamento: VÍDEO bypassa WAF/Backend completamente
    use_backend mediamtx_hls if is_hls
    use_backend mediamtx_hls if is_video_file
    use_backend mediamtx_webrtc if is_webrtc
    
    # Roteamento: API vai para Gateway (FastAPI) → Django
    use_backend api_gateway if is_api
    
    # Roteamento: Estáticos e Frontend vão para Nginx
    use_backend nginx_static if is_static
    default_backend nginx_static

# ============================================
# BACKEND - MediaMTX HLS (Vídeo)
# ============================================
backend mediamtx_hls
    mode http
    balance roundrobin
    
    # Remove /hls/ do path antes de enviar para MediaMTX
    http-request replace-path /hls/(.*) /\1
    
    server mediamtx1 mediamtx:8888 check inter 10s fall 3 rise 2
    
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Cache-Control "no-cache"

# ============================================
# BACKEND - MediaMTX WebRTC (Vídeo Baixa Latência)
# ============================================
backend mediamtx_webrtc
    mode http
    balance roundrobin
    option httpchk GET /
    
    # Sticky session para WebRTC (importante!)
    stick-table type ip size 100k expire 30m
    stick on src
    
    # CONFIGURÁVEL: Adicionar mais instâncias MediaMTX
    server mediamtx1 mediamtx:8889 check inter 10s fall 3 rise 2
    
    # Headers para WebSocket
    http-response set-header Access-Control-Allow-Origin "*"

# ============================================
# BACKEND - API Gateway (FastAPI → Django)
# ============================================
backend api_gateway
    mode http
    balance roundrobin              # CONFIGURÁVEL: leastconn para melhor distribuição
    option httpchk GET /docs
    
    # CONFIGURÁVEL: Adicionar mais réplicas do Gateway
    server gateway1 gateway:8000 check inter 10s fall 3 rise 2
    # server gateway2 gateway:8000 check inter 10s fall 3 rise 2
    
    # Headers para API
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Proto https if { ssl_fc }

# ============================================
# BACKEND - Nginx (Frontend + Estáticos)
# ============================================
backend nginx_static
    mode http
    balance roundrobin
    option httpchk GET /
    
    server nginx1 nginx:80 check inter 10s fall 3 rise 2
    
    # Cache agressivo para estáticos
    acl is_static_path path_beg /static/
    http-response set-header Cache-Control "public, max-age=604800" if is_static_path

# ============================================
# STATS (Monitoramento HAProxy)
# ============================================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
