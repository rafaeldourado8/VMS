###############################################
# MediaMTX configuration file
###############################################

###############################################
# Global settings

logLevel: info
logDestinations: [stdout]
logFile: mediamtx.log
sysLogPrefix: mediamtx

# CONFIGURÁVEL: Timeouts para 250 câmeras
readTimeout: 10s              # Timeout de leitura RTSP
writeTimeout: 10s             # Timeout de escrita
writeQueueSize: 1024          # CONFIGURÁVEL: Aumentado de 512 para 250 câmeras (buffer de escrita)
udpMaxPayloadSize: 1472       # MTU padrão

runOnConnect:
runOnConnectRestart: no
runOnDisconnect:

###############################################
# Global settings -> Authentication

authMethod: internal

authInternalUsers:
  - user: any
    pass:
    ips: []
    permissions:
      - action: publish
        path:
      - action: read
        path:
      - action: playback
        path:

  - user: any
    pass:
    ips: ['127.0.0.1', '::1']
    permissions:
      - action: api
      - action: metrics
      - action: pprof

  - user: mediamtx_api_user
    pass: "GtV!sionMed1aMTX$2025"
    ips: []
    permissions:
      - action: api

# Optional: HTTP auth backend
authHTTPAddress:
authHTTPExclude:
- action: api
- action: metrics
- action: pprof

# JWT (optional)
authJWTJWKS:
authJWTJWKSFingerprint:
authJWTClaimKey: mediamtx_permissions
authJWTExclude: []
authJWTInHTTPQuery: true

###############################################
# Global settings -> Control API

api: yes
apiAddress: :9997
apiEncryption: no
apiServerKey: server.key
apiServerCert: server.crt
apiAllowOrigins: ['*']
apiTrustedProxies: []

###############################################
# Global settings -> Metrics

metrics: yes
metricsAddress: :9998
metricsEncryption: no
metricsServerKey: server.key
metricsServerCert: server.crt
metricsAllowOrigins: ['*']
metricsTrustedProxies: []

###############################################
# Global settings -> PPROF

pprof: no
pprofAddress: :9999
pprofEncryption: no
pprofServerKey: server.key
pprofServerCert: server.crt
pprofAllowOrigins: ['*']
pprofTrustedProxies: []

###############################################
# Global settings -> Playback server

playback: yes
playbackAddress: :9996
playbackEncryption: no
playbackServerKey: server.key
playbackServerCert: server.crt
playbackAllowOrigins: ['*']
playbackTrustedProxies: []

###############################################
# Global settings -> RTSP server

rtsp: yes
rtspTransports: [tcp, udp]        # CONFIGURÁVEL: TCP primeiro (mais estável para câmeras remotas)
rtspEncryption: "no"
rtspAddress: :8554
rtspsAddress: :8322
rtpAddress: :8000
rtcpAddress: :8001
multicastIPRange: 224.1.0.0/16
multicastRTPPort: 8002
multicastRTCPPort: 8003
srtpAddress: :8004
srtcpAddress: :8005
multicastSRTPPort: 8006
multicastSRTCPPort: 8007
rtspServerKey: server.key
rtspServerCert: server.crt
rtspAuthMethods: [basic]
rtspUDPReadBufferSize: 0

###############################################
# Global settings -> RTMP server

rtmp: yes
rtmpAddress: :1935
rtmpEncryption: "no"
rtmpsAddress: :1936
rtmpServerKey: server.key
rtmpServerCert: server.crt

###############################################
# Global settings -> HLS server

hls: yes
hlsAddress: :8888
hlsEncryption: no
hlsServerKey: server.key
hlsServerCert: server.crt
hlsAllowOrigins: ['*']
hlsTrustedProxies: []
hlsAlwaysRemux: no

# CONFIGURÁVEL: HLS otimizado para 250 câmeras
hlsVariant: mpegts            # mpegts = compatível, fmp4 = moderno mas pode dar erro
hlsSegmentCount: 3            # CONFIGURÁVEL: Reduzido de 5 para 3 (menos memória, buffer menor)
hlsSegmentDuration: 2s        # CONFIGURÁVEL: 2s = equilíbrio latência/carga (1s=baixa latência, 4s=menos CPU)
hlsSegmentMaxSize: 50M        # Tamanho máximo do segmento
hlsDirectory: ''              # Segmentos em memória (mais rápido)
hlsMuxerCloseAfter: 60s       # Fecha muxer após 60s de inatividade

###############################################
# Global settings -> WebRTC server

webrtc: yes
webrtcAddress: :8889
webrtcEncryption: no
webrtcServerKey: server.key
webrtcServerCert: server.crt
webrtcAllowOrigins: ['*']
webrtcTrustedProxies: []
webrtcLocalUDPAddress: :8189
# webrtcLocalTCPAddress: :8889 # Comentado para evitar conflito
webrtcIPsFromInterfaces: yes
webrtcIPsFromInterfacesList: []
webrtcAdditionalHosts: ["127.0.0.1", "localhost"]
webrtcICEServers2: []
webrtcHandshakeTimeout: 10s
webrtcTrackGatherTimeout: 2s
webrtcSTUNGatherTimeout: 5s

###############################################
# Global settings -> SRT server

srt: yes
srtAddress: :8890

###############################################
# Default path settings

pathDefaults:
  source: publisher
  sourceFingerprint:
  sourceOnDemand: no
  sourceOnDemandStartTimeout: 10s
  sourceOnDemandCloseAfter: 10s
  maxReaders: 100             # CONFIGURÁVEL: Limite de leitores simultâneos por stream (0=ilimitado, 100=seguro)
  srtReadPassphrase:
  fallback:
  useAbsoluteTimestamp: false

  # CONFIGURÁVEL: Gravação otimizada para 250 câmeras
  record: yes
  recordPath: /recordings/%path/%Y-%m-%d_%H-%M-%S-%f
  recordFormat: fmp4          # fmp4 = moderno e eficiente
  recordPartDuration: 2s      # CONFIGURÁVEL: Duração de cada parte (2s = menos I/O)
  recordMaxPartSize: 50M      # Tamanho máximo por parte
  recordSegmentDuration: 1h   # CONFIGURÁVEL: Segmento de 1h (facilita busca/playback)
  recordDeleteAfter: 7d       # CONFIGURÁVEL: Retenção de 7 dias (ajustar conforme disco disponível)

  overridePublisher: yes
  srtPublishPassphrase:

  rtspTransport: tcp              # CONFIGURÁVEL: Força TCP (evita packet loss)
  rtspAnyPort: no
  rtspRangeType:
  rtspRangeStart:
  rtspUDPReadBufferSize: 8388608  # CONFIGURÁVEL: 8MB buffer

  mpegtsUDPReadBufferSize: 0
  rtpSDP:
  rtpUDPReadBufferSize: 0
  sourceRedirect:
  rpiCameraCamID: 0
  rpiCameraSecondary: false
  rpiCameraWidth: 1920
  rpiCameraHeight: 1080
  rpiCameraHFlip: false
  rpiCameraVFlip: false
  rpiCameraBrightness: 0
  rpiCameraContrast: 1
  rpiCameraSaturation: 1
  rpiCameraSharpness: 1
  rpiCameraExposure: normal
  rpiCameraAWB: auto
  rpiCameraAWBGains: [0, 0]
  rpiCameraDenoise: "off"
  rpiCameraShutter: 0
  rpiCameraMetering: centre
  rpiCameraGain: 0
  rpiCameraEV: 0
  rpiCameraLensPosition: 0.0
  rpiCameraAfWindow:
  rpiCameraFlickerPeriod: 0
  rpiCameraTextOverlayEnable: false
  rpiCameraTextOverlay: '%Y-%m-%d %H:%M:%S - MediaMTX'
  rpiCameraCodec: auto
  rpiCameraIDRPeriod: 60
  rpiCameraBitrate: 5000000
  rpiCameraHardwareH264Profile: main
  rpiCameraHardwareH264Level: '4.1'
  rpiCameraSoftwareH264Profile: baseline
  rpiCameraSoftwareH264Level: '4.1'
  rpiCameraMJPEGQuality: 60

###############################################
# Path settings

paths:
  # Câmeras reais (teste)
  cam_1:
    source: rtsp://admin:Camerite123@45.236.226.75:6053/cam/realmonitor?channel=1&subtype=0
    sourceOnDemand: yes
    sourceOnDemandStartTimeout: 10s
    sourceOnDemandCloseAfter: 10s
    
  cam_2:
    source: rtsp://admin:Camerite123@45.236.226.75:6052/cam/realmonitor?channel=1&subtype=0
    sourceOnDemand: yes
    
  cam_3:
    source: rtsp://admin:Camerite123@45.236.226.74:6050/cam/realmonitor?channel=1&subtype=0
    sourceOnDemand: yes
    
  cam_4:
    source: rtsp://admin:Camerite123@45.236.226.72:6049/cam/realmonitor?channel=1&subtype=0
    sourceOnDemand: yes
    
  cam_5:
    source: rtsp://admin:Camerite123@45.236.226.71:6046/cam/realmonitor?channel=1&subtype=0
    sourceOnDemand: yes
    
  cam_6:
    source: rtsp://admin:Camerite123@45.236.226.70:6045/cam/realmonitor?channel=1&subtype=0
    sourceOnDemand: yes
